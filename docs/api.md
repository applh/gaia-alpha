# API Documentation

## Media API
The Media API handles secure image serving, resizing, and caching.

**Endpoint**: `/media/{user_id}/{filename}`

### Parameters
| Query Param | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `w` | Int | `0` (orig) | Target width |
| `h` | Int | `0` (orig) | Target height |
| `q` | Int | `80` | Quality (1-100) |
| `fit` | String | `contain` | `contain` or `cover` |

### Examples
- **Original**: `/media/1/image.jpg`
- **Thumbnail (200px wide)**: `/media/1/image.jpg?w=200`
- **Thumbnail (200px wide)**: `/media/1/image.jpg?w=200`
- **Square Crop (150x150)**: `/media/1/image.jpg?w=150&h=150&fit=cover`

### Cache Management
- `GET /@/media/cache`: Get cache stats (count, size).
- `POST /@/media/cache/clear`: Clear the media cache.

---

## Core JSON API
These endpoints return JSON and require Session Authentication.

### Global
- `GET /@/user`: Returns current user info (`id`, `username`, `level`).

### Todo Management
- `GET /@/todos`: List user's todos (ordered by hierarchy).
  - **Query Params**: `label` - Filter by label (e.g., `?label=work`)
- `POST /@/todos`: Create a new todo.
  - Body: `{"title": "My Task", "parent_id": 1, "labels": "work,urgent"}`
  - `parent_id` (optional): ID of parent todo for hierarchical structure
  - `labels` (optional): Comma-separated labels
- `PATCH /@/todos/{id}`: Update a todo.
  - Body: `{"title": "...", "completed": true, "parent_id": 2, "labels": "work"}`
  - All fields are optional
- `DELETE /@/todos/{id}`: Delete a todo.
  - Note: Children are unlinked (parent_id set to NULL), not deleted
- `GET /@/todos/{id}/children`: Get all child todos of a parent.


### Admin Handlers
- `POST /@/admin/users/delete`: Delete a user (Level 100+ only).
  - Body: `{"id": 456}`

### File Uploads
- `POST /@/upload`: Upload an image.
  - **Multipart Form Data**: field `file`
  - **Returns**: `{"url": "/media/1/newimage.jpg"}`

### CMS
- `GET /@/cms/pages`: List all pages.
  - **Query Params**:
    - `cat`: "page" | "image" (default: "page")
- `POST /@/cms/pages`: Create a page.
  - **Body**: `{"title":"...","slug":"...","content":"...","image":"...","cat":"page"}`
- `PATCH /@/cms/pages/{id}`: Update a page.
  - **Body**: `{"title":"...","content":"...","image":"..."}`
- `DELETE /@/cms/pages/{id}`: Delete a page.
- `POST /@/cms/upload`: Upload an image.
  - **Multipart Form Data**: field `image`
  - **Returns**: `{"url": "/media/1/newimage.webp"}`
  - **Processing**: 
    - Accepts JPEG, PNG, WebP
    - Converts to WebP format
    - Resizes to max 3840x2160 if larger
    - Stores in `uploads/{user_id}/`
    - Auto-creates CMS entry with `cat='image'`

### Admin
- `GET /@/admin/stats`: Get system statistics (Admin only).
  - **Returns**: `{"users": 12, "todos": 6, "pages": 3, "images": 1}`
- `GET /@/admin/users`: List all users (Admin only).
- `POST /@/admin/users`: Create a user (Admin only).
  - **Body**: `{"username":"...","password":"...","level":10}`
- `PATCH /@/admin/users/{id}`: Update a user (Admin only).
  - **Body**: `{"level":100,"password":"..."}`
- `DELETE /@/admin/users/{id}`: Delete a user (Admin only).

### Database Manager (Admin Only)
- `GET /@/admin/db/tables`: List all database tables.
  - **Returns**: `{"tables": ["users", "todos", "cms_pages", "data_store"]}`
- `GET /@/admin/db/table/{tableName}`: Get table schema and data.
  - **Returns**: `{"table": "users", "schema": [...], "data": [...], "count": 10}`
- `POST /@/admin/db/query`: Execute a SQL query.
  - **Body**: `{"query": "SELECT * FROM users WHERE level >= 100"}`
  - **Returns**: 
    - SELECT: `{"success": true, "type": "select", "results": [...], "count": 5}`
    - Other: `{"success": true, "type": "modification", "affected_rows": 3}`
- `POST /@/admin/db/table/{tableName}`: Create a record.
  - **Body**: `{"column1": "value1", "column2": "value2"}`
  - **Returns**: `{"success": true, "id": "123"}`
- `PATCH /@/admin/db/table/{tableName}/{id}`: Update a record.
  - **Body**: `{"column1": "new_value"}`
  - **Returns**: `{"success": true}`
- `DELETE /@/admin/db/table/{tableName}/{id}`: Delete a record.
  - **Returns**: `{"success": true}`

### API Builder (Admin Only)
- `GET /@/admin/api-builder/tables`: List all tables and their API config status.
- `POST /@/admin/api-builder/config`: Enable/Disable API for a table.
  - **Body**: `{"name": "users", "config": {"enabled": true, "methods": ["GET"], "auth_level": "admin"}}`

### Dynamic APIs
These endpoints are generated by the API Builder for enabled tables.
- `GET /@/v1/{table}`: List items (supports pagination `?page=X&limit=Y` and sorting `?sort=col&order=desc`).
- `GET /@/v1/{table}/{id}`: Get single item.
- `POST /@/v1/{table}`: Create item.
- `PUT /@/v1/{table}/{id}`: Update item.
- `DELETE /@/v1/{table}/{id}`: Delete item.

### Menus
- `GET /@/menus`: List all menus.
- `POST /@/menus`: Create a menu.
- `GET /@/menus/{id}`: Get a specific menu.
- `PATCH /@/menus/{id}`: Update a menu.
- `DELETE /@/menus/{id}`: Delete a menu.

### Public Pages (JSON)
- `GET /@/public/pages`: List public pages.
- `GET /@/public/pages/{slug}`: Get a public page by slug.
